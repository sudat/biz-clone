# ダミーデータ投入手順（仕訳 1,000 件など）

このドキュメントでは、開発・デモ用途の仕訳ダミーデータを **最小限の手間** で投入する方法を説明します。

> ❗️ 本番環境には絶対に実行しないでください。`NODE_ENV === "production"` では API も 403 を返すようガードしています。

---

## 1. 事前準備

1. `.env` に **`DATABASE_URL`** が設定され、`prisma migrate dev` などでスキーマが適用されていること。
2. `npm i` あるいは `bun install` 済みで依存パッケージ（`@faker-js/faker` など）がインストールされていること。

---

## 2. CLI でまとめて投入する

### 2-1. マスタ + ダミー仕訳を一括投入

```bash
# 1. まだマイグレーションが走っていない場合
npx prisma migrate dev  # または bunx prisma migrate dev

# 2. Prisma のシードを実行（マスタ + 仕訳 1,000 件）
# package.json の prisma.seed に登録済み
npx prisma db seed       # または bunx prisma db seed
```

### 2-2. 件数を変えて投入したい場合

```bash
# 例: 5,000 件投入
bunx ts-node scripts/seed-sample-journals.ts 5000
```

- **scripts/seed-sample-journals.ts** 内部では `generateSampleJournals(count)` を呼び出しています。
- 引数を省略するとデフォルトで **1,000 件** を生成します。

---

## 3. 開発用 API から生成する

Next.js の開発サーバ (`next dev`) を起動した状態で、以下の API に POST します。

| メソッド | エンドポイント               | ボディ例            |
| -------- | ---------------------------- | ------------------- |
| POST     | `/api/dev/generate-journals` | `{ "count": 1500 }` |

### 3-1. fetch 例（ブラウザ DevTools などから）

```js
await fetch("/api/dev/generate-journals", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ count: 1500 }),
});
```

- **count** を省略すると 1,000 件生成します。
- 本番ビルド (`next build && next start`) あるいは `NODE_ENV=production` の環境では **403 Forbidden** が返ります。

---

## 4. 実装概要

| ファイル                                 | 役割                                                                      |
| ---------------------------------------- | ------------------------------------------------------------------------- |
| `lib/utils/sample-journal-generator.ts`  | 仕訳ヘッダ・明細をまとめて生成する共通ライブラリ。faker + Prisma を使用。 |
| `scripts/seed-sample-journals.ts`        | CLI から呼び出すシードスクリプト。件数引数を受け取り、ライブラリを実行。  |
| `app/api/dev/generate-journals/route.ts` | 開発環境限定 API ルート。POST リクエストでダミーデータを生成。            |
| `package.json` の `prisma.seed`          | シード実行時にマスタ投入とダミーデータ投入を連続実行。                    |

---

## 5. よくある質問

### Q. テストデータをすべて削除したい

```bash
a) データベースをリセット
npx prisma migrate reset --force  # 開発 DB でのみ使用!!

b) 仕訳テーブルだけを削除する SQL を実行
TRUNCATE TABLE journal_details, journal_headers RESTART IDENTITY CASCADE;
```

### Q. faker の乱数シードを固定したい

`sample-journal-generator.ts` の冒頭で `faker.seed(1234);` を追加すれば再現性のあるデータが生成できます。

---

### 更新履歴

| 日付       | 変更者  | 変更内容 |
| ---------- | ------- | -------- |
| 2025-06-14 | AI 生成 | 初版作成 |
