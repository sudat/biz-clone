# 型システム統一

## 概要

Biz Clone では、TypeScript の型安全性を最大限活用するため、システム全体で統一された型定義を使用しています。  
**2025年6月の大型リファクタリング**により、全ての型定義が整理・統一され、開発効率とコード品質が大幅に向上しました。

## 型定義ファイル構成

```
types/
├── master-types.ts        # マスタ系統一型定義
├── journal.ts             # 仕訳系統一型定義
├── tax.ts                 # 消費税系統一型定義
└── client.ts              # Client Component用型変換
```

## マスタ系型定義

### 1. 勘定科目関連 (`types/master-types.ts`)

```typescript
// 勘定科目種別
export const ACCOUNT_TYPE_LIST = [
  "資産", "負債", "資本", "収益", "費用"
] as const;
export type AccountType = typeof ACCOUNT_TYPE_LIST[number];

// 勘定科目種別オプション（UI用）
export const ACCOUNT_TYPE_OPTIONS = [
  { value: "資産", label: "資産" },
  { value: "負債", label: "負債" },
  { value: "資本", label: "資本" },
  { value: "収益", label: "収益" },
  { value: "費用", label: "費用" },
] as const;

// 勘定科目マスタフォーム型
export interface AccountMasterFormData {
  accountCode: string;
  accountName: string;
  accountType: AccountType;
  parentAccountCode?: string | null;
  isDetail: boolean;
  isActive: boolean;
  sortOrder?: number | null;
}
```

### 2. 取引先関連

```typescript
// 取引先種別
export const PARTNER_TYPE_LIST = [
  "得意先", "仕入先", "金融機関", "その他"
] as const;
export type PartnerType = typeof PARTNER_TYPE_LIST[number];

// 取引先種別オプション（UI用）
export const PARTNER_TYPE_OPTIONS = [
  { value: "得意先", label: "得意先" },
  { value: "仕入先", label: "仕入先" },
  { value: "金融機関", label: "金融機関" },
  { value: "その他", label: "その他" },
] as const;

// 取引先マスタフォーム型
export interface PartnerMasterFormData {
  partnerCode: string;
  partnerName: string;
  partnerKana?: string;
  partnerType: PartnerType;
  postalCode?: string;
  address?: string;
  phone?: string;
  email?: string;
  contactPerson?: string;
  isActive: boolean;
}
```

### 3. 分析コード関連

```typescript
// 分析コード型定義
export interface AnalysisCodeFormData {
  analysisCode: string;
  analysisName: string;
  analysisType: string;
  parentAnalysisCode?: string;
  sortOrder?: number;
  isActive: boolean;
}
```

### 4. 補助科目関連

```typescript
// 補助科目型定義
export interface SubAccountFormData {
  accountCode: string;
  subAccountCode: string;
  subAccountName: string;
  isActive: boolean;
  sortOrder?: number | null;
}
```

## 消費税系型定義 (`types/tax.ts`)

### 1. 消費税種別

```typescript
// 消費税種別（拡張可能）
export const TAX_TYPE_LIST = [
  "taxable",     // 課税
  "non_taxable", // 非課税
  "tax_free",    // 免税
  "tax_entry"    // 税込
] as const;
export type TaxType = typeof TAX_TYPE_LIST[number];

// デフォルト消費税種別
export const DEFAULT_TAX_TYPE: TaxType = "taxable";
```

### 2. UI表示用オプション

```typescript
// 消費税種別オプション（UI用）
export const TAX_TYPE_OPTIONS = [
  { value: "taxable", label: "課税" },
  { value: "non_taxable", label: "非課税" },
  { value: "tax_free", label: "免税" },
  { value: "tax_entry", label: "税込" },
] as const;

// 消費税計算ロジック
export function calculateTax(baseAmount: number, taxType: TaxType): number {
  switch (taxType) {
    case "taxable":
      return Math.floor(baseAmount * 0.1); // 10%消費税
    case "tax_entry":
      return Math.floor(baseAmount / 11); // 税込み金額から消費税を逆算
    case "non_taxable":
    case "tax_free":
    default:
      return 0;
  }
}
```

### 3. 拡張性の考慮

```typescript
// 将来的な消費税率変更に対応
export interface TaxRateConfig {
  rate: number;
  effectiveDate: Date;
  description: string;
}

export const TAX_RATE_HISTORY: TaxRateConfig[] = [
  {
    rate: 0.1,
    effectiveDate: new Date('2019-10-01'),
    description: '消費税率10%'
  },
  {
    rate: 0.08,
    effectiveDate: new Date('2014-04-01'),
    description: '消費税率8%'
  }
];
```

## 仕訳系型定義 (`types/journal.ts`)

### 1. 仕訳明細データ

```typescript
import { TaxType } from "./tax";

// 仕訳明細データ（UI⇔Server Actions間での統一インターフェース）
export interface JournalDetailData {
  debitCredit: "debit" | "credit";
  accountCode: string;
  subAccountCode?: string;
  partnerCode?: string;
  analysisCode?: string;
  baseAmount: number;      // 本体金額
  taxAmount: number;       // 消費税額
  totalAmount: number;     // 合計金額（本体+消費税）
  taxType: TaxType;
  description?: string;
}

// 仕訳ヘッダーデータ
export interface JournalHeaderData {
  journalDate: string;     // YYYY-MM-DD形式
  description: string;
}

// 仕訳保存データ（Server Action用）
export interface JournalSaveData {
  header: JournalHeaderData;
  details: JournalDetailData[];
}
```

### 2. 検証・計算用型

```typescript
// 借貸バランス検証結果
export interface BalanceValidationResult {
  isValid: boolean;
  error?: string;
  debitTotal?: number;
  creditTotal?: number;
}

// 仕訳番号生成用
export interface JournalNumberConfig {
  date: Date;
  sequence: number;
}
```

## Client Component用型変換 (`types/client.ts`)

### 1. Decimal型からnumber型への変換

```typescript
import type { Account, Partner, SubAccount, AnalysisCode } from "@/lib/database/prisma";

// Prismaの Decimal 型を number 型に変換した Client Component 用の型

export type AccountForClient = Omit<Account, 'defaultTaxRate'> & {
  defaultTaxRate: number | null;
};

export type PartnerForClient = Partner; // Decimal フィールドなし

export type SubAccountForClient = SubAccount; // Decimal フィールドなし

export type AnalysisCodeForClient = AnalysisCode; // Decimal フィールドなし
```

### 2. フォーム用拡張型

```typescript
// リレーション付きの型（一覧表示用）
export interface SubAccountWithAccount extends SubAccount {
  account?: {
    accountCode: string;
    accountName: string;
  };
}

// 検索結果用の軽量型
export interface AccountSearchResult {
  accountCode: string;
  accountName: string;
  accountType: string;
}

export interface PartnerSearchResult {
  partnerCode: string;
  partnerName: string;
  partnerType: string;
}
```

## Server Actions との型統合

### 1. ユニークチェック用型

```typescript
// Server Actions の戻り値型
export interface UniqueCheckResult<T = any> {
  exists: boolean;
  data?: T;
}

// 各マスタのユニークチェック型
export type AccountUniqueCheck = UniqueCheckResult<{
  accountCode: string;
  accountName: string;
  accountType: string;
  isActive: boolean;
}>;

export type PartnerUniqueCheck = UniqueCheckResult<{
  partnerCode: string;
  partnerName: string;
  partnerType: string;
  isActive: boolean;
}>;
```

### 2. Server Action 標準応答型

```typescript
// 統一された Server Action 応答型
export interface ActionResult<T = any> {
  success: boolean;
  data?: T;
  error?: string;
  type?: 'validation' | 'business' | 'database' | 'unknown';
}

// CRUD操作用の応答型
export type CreateResult<T> = ActionResult<T>;
export type UpdateResult<T> = ActionResult<T>;
export type DeleteResult = ActionResult<void>;
export type GetResult<T> = ActionResult<T[]>;
```

## 型ガード関数

### 1. マスタ種別判定

```typescript
// 勘定科目種別の型ガード
export function isValidAccountType(value: string): value is AccountType {
  return ACCOUNT_TYPE_LIST.includes(value as AccountType);
}

// 取引先種別の型ガード
export function isValidPartnerType(value: string): value is PartnerType {
  return PARTNER_TYPE_LIST.includes(value as PartnerType);
}

// 消費税種別の型ガード
export function isValidTaxType(value: string): value is TaxType {
  return TAX_TYPE_LIST.includes(value as TaxType);
}
```

### 2. データ形式検証

```typescript
// 日付文字列の検証
export function isValidDateString(value: string): boolean {
  const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
  if (!dateRegex.test(value)) return false;
  
  const date = new Date(value);
  return date instanceof Date && !isNaN(date.getTime());
}

// 金額の検証
export function isValidAmount(value: number): boolean {
  return typeof value === 'number' && value >= 0 && Number.isFinite(value);
}
```

## 利用メリット

### 1. 型安全性

- **コンパイル時エラー検出**: 型の不整合を事前に発見
- **IntelliSense**: IDE での自動補完・型情報表示
- **リファクタリング安全性**: 型定義変更時の影響範囲を把握

### 2. 開発効率

- **統一インターフェース**: 同じデータ構造を複数箇所で再利用
- **自動生成**: as const による型の自動推論
- **拡張性**: 新しい選択肢の追加が容易

### 3. 保守性

- **単一責任**: 各ファイルが特定の型定義のみを担当
- **依存関係明確化**: import/export による明示的な依存関係
- **バージョン管理**: 型定義の変更履歴を追跡可能

この統一された型システムにより、大規模な会計システムでも型安全性を保ちながら効率的な開発が可能になっています。