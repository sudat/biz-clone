# 開発・テスト環境

## 概要

Biz Clone の開発環境は、現代的な開発ツールとベストプラクティスを採用し、効率的で品質の高い開発体験を提供します。  
**型安全性**と**自動化**を重視し、継続的な品質向上を実現しています。

## 開発環境構成

### 1. 必要なソフトウェア

#### 基本環境

- **Node.js** 20.x 以上
- **npm** または **Bun** （パッケージマネージャー）
- **Git** バージョン管理
- **PostgreSQL** 15.x 以上（ローカル開発用）

#### 推奨開発ツール

- **VS Code** - エディター
- **Docker** - 開発環境統一
- **Supabase CLI** - Supabase 操作
- **Prisma CLI** - データベース管理

### 2. 開発環境セットアップ

#### プロジェクトクローン・初期設定

```bash
# リポジトリクローン
git clone <repository-url>
cd biz-clone

# 依存関係インストール
npm install
# または
bun install

# 環境変数設定
cp .env.example .env
# .env ファイルを編集して必要な値を設定
```

#### データベースセットアップ

```bash
# Prisma クライアント生成
npx prisma generate

# データベースマイグレーション
npx prisma migrate dev

# シードデータ投入（オプション）
npx prisma db seed
```

#### 開発サーバー起動

```bash
# 開発サーバー起動
npm run dev
# または
bun dev

# ブラウザで http://localhost:3000 にアクセス
```

## 環境変数設定

### 1. 必須環境変数

```bash
# .env ファイル設定例
# データベース接続
DATABASE_URL="postgresql://user:password@localhost:5432/biz_clone_dev"
DIRECT_URL="postgresql://user:password@localhost:5432/biz_clone_dev"

# Supabase設定
NEXT_PUBLIC_SUPABASE_URL="your-supabase-url"
NEXT_PUBLIC_SUPABASE_ANON_KEY="your-supabase-anon-key"
SUPABASE_SERVICE_ROLE_KEY="your-service-role-key"

# 認証設定
NEXTAUTH_SECRET="your-secret-key"
NEXTAUTH_URL="http://localhost:3000"
```

### 2. 開発環境別設定

#### ローカル開発

```bash
NODE_ENV=development
DEBUG=true
LOG_LEVEL=debug
```

#### ステージング環境

```bash
NODE_ENV=staging
DEBUG=false
LOG_LEVEL=info
```

#### 本番環境

```bash
NODE_ENV=production
DEBUG=false
LOG_LEVEL=error
```

## テスト戦略

### 1. テストピラミッド

```mermaid
graph TD
    E2E[E2E Tests<br/>Playwright]
    INT[Integration Tests<br/>API・DB連携]
    UNIT[Unit Tests<br/>ビジネスロジック]

    style E2E fill:#ffeb3b,color:#000
    style INT fill:#4caf50,color:#fff
    style UNIT fill:#2196f3,color:#fff

    E2E --> INT
    INT --> UNIT
```

### 2. テストの種類と責務

#### Unit Tests（単体テスト）

**場所**: `__tests__/unit/`  
**対象**: Service クラス、Utility 関数  
**ツール**: Jest, Testing Library

```typescript
// __tests__/unit/services/AccountService.test.ts
describe("AccountService", () => {
  let accountService: AccountService;
  let mockRepository: jest.Mocked<IAccountRepository>;

  beforeEach(() => {
    mockRepository = {
      findById: jest.fn(),
      create: jest.fn(),
      // ...
    } as jest.Mocked<IAccountRepository>;

    accountService = new AccountService(mockRepository);
  });

  describe("createAccount", () => {
    it("正常な勘定科目データで作成できること", async () => {
      const accountData: AccountCreateDto = {
        accountCode: "TEST001",
        accountName: "テスト勘定科目",
        accountType: "資産",
        isDetail: true,
        isActive: true,
        sortOrder: 1,
      };

      mockRepository.create.mockResolvedValue({
        ...accountData,
        createdAt: new Date(),
        updatedAt: new Date(),
      } as Account);

      const result = await accountService.createAccount(accountData);

      expect(mockRepository.create).toHaveBeenCalledWith(accountData);
      expect(result.accountCode).toBe("TEST001");
    });

    it("無効な勘定科目コードでエラーになること", async () => {
      const invalidData: AccountCreateDto = {
        accountCode: "invalid-code",
        accountName: "テスト",
        accountType: "資産",
        isDetail: true,
        isActive: true,
        sortOrder: 1,
      };

      await expect(accountService.createAccount(invalidData)).rejects.toThrow(
        "勘定科目コードは3-10文字の英数字で入力してください"
      );
    });
  });
});
```

#### Integration Tests（統合テスト）

**場所**: `__tests__/integration/`  
**対象**: API エンドポイント、データベース連携  
**ツール**: Jest, Supertest

```typescript
// __tests__/integration/api/accounts.test.ts
describe("/api/accounts", () => {
  let app: NextApiHandler;
  let testDb: PrismaClient;

  beforeAll(async () => {
    // テスト用データベース準備
    testDb = new PrismaClient({
      datasources: { db: { url: process.env.TEST_DATABASE_URL } },
    });
    await testDb.$connect();
  });

  afterAll(async () => {
    await testDb.$disconnect();
  });

  beforeEach(async () => {
    // テストデータ初期化
    await testDb.account.deleteMany();
  });

  describe("POST /api/accounts", () => {
    it("勘定科目を作成できること", async () => {
      const accountData = {
        accountCode: "TEST001",
        accountName: "テスト勘定科目",
        accountType: "資産",
        isDetail: true,
        isActive: true,
        sortOrder: 1,
      };

      const response = await request(app)
        .post("/api/accounts")
        .send(accountData)
        .expect(201);

      expect(response.body).toMatchObject(accountData);

      // データベースに保存されていることを確認
      const saved = await testDb.account.findUnique({
        where: { accountCode: "TEST001" },
      });
      expect(saved).toBeTruthy();
    });
  });
});
```

#### E2E Tests（エンドツーエンドテスト）

**場所**: `__tests__/e2e/`  
**対象**: ユーザーシナリオ全体  
**ツール**: Playwright

```typescript
// __tests__/e2e/account-management.spec.ts
import { test, expect } from "@playwright/test";

test.describe("勘定科目管理", () => {
  test.beforeEach(async ({ page }) => {
    // ログイン処理
    await page.goto("/login");
    await page.fill('[name="email"]', "test@example.com");
    await page.fill('[name="password"]', "password");
    await page.click('[type="submit"]');
    await page.waitForURL("/dashboard");
  });

  test("勘定科目の作成から削除まで", async ({ page }) => {
    // 勘定科目管理画面に移動
    await page.goto("/master/accounts");
    await expect(page).toHaveTitle(/勘定科目管理/);

    // 新規作成ボタンクリック
    await page.click('[data-testid="create-account-button"]');

    // フォーム入力
    await page.fill('[name="accountCode"]', "E2E001");
    await page.fill('[name="accountName"]', "E2Eテスト勘定科目");
    await page.selectOption('[name="accountType"]', "資産");

    // 保存
    await page.click('[type="submit"]');
    await expect(page.locator('[data-testid="success-message"]')).toContainText(
      "勘定科目を作成しました"
    );

    // 一覧画面に戻って確認
    await page.goto("/master/accounts");
    await expect(page.locator('[data-testid="account-list"]')).toContainText(
      "E2E001"
    );

    // 削除
    await page.click('[data-testid="account-E2E001-delete"]');
    await page.click('[data-testid="confirm-delete"]');
    await expect(page.locator('[data-testid="success-message"]')).toContainText(
      "勘定科目を削除しました"
    );
  });
});
```

### 3. テスト実行コマンド

```bash
# 全テスト実行
npm test

# Unit テストのみ
npm run test:unit

# Integration テストのみ
npm run test:integration

# E2E テストのみ
npm run test:e2e

# E2E テスト（UI モード）
npm run test:e2e:ui

# テストカバレッジ取得
npm run test:coverage

# テスト監視モード
npm run test:watch
```

## 品質保証ツール

### 1. 静的解析

#### ESLint 設定

```javascript
// eslint.config.mjs
export default [
  {
    files: ["**/*.{js,jsx,ts,tsx}"],
    rules: {
      "@typescript-eslint/no-unused-vars": "error",
      "@typescript-eslint/explicit-function-return-type": "warn",
      "react/prop-types": "off",
      "react/react-in-jsx-scope": "off",
    },
  },
  {
    files: ["**/__tests__/**"],
    rules: {
      "@typescript-eslint/explicit-function-return-type": "off",
    },
  },
];
```

#### TypeScript 設定

```json
// tsconfig.json
{
  "compilerOptions": {
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "exactOptionalPropertyTypes": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedIndexedAccess": true
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx"],
  "exclude": ["node_modules", "dist", ".next"]
}
```

### 2. パフォーマンス監視

#### Next.js Bundle Analyzer

```bash
# バンドルサイズ分析
npm run analyze

# パフォーマンス測定
npm run lighthouse
```

#### 実行時監視

```typescript
// lib/utils/performance.ts
export function measureAsync<T>(
  name: string,
  fn: () => Promise<T>
): Promise<T> {
  const start = performance.now();
  return fn().finally(() => {
    const duration = performance.now() - start;
    console.log(`${name}: ${duration.toFixed(2)}ms`);
  });
}
```

### 3. セキュリティ

#### npm audit

```bash
# 脆弱性チェック
npm audit

# 自動修正
npm audit fix
```

#### OWASP ZAP 連携

```bash
# セキュリティスキャン
npm run security:scan
```

## CI/CD パイプライン

### 1. GitHub Actions 設定

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Run database migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test

      - name: Run lint
        run: npm run lint

      - name: Run type check
        run: npm run type-check

      - name: Run unit tests
        run: npm run test:unit

      - name: Run integration tests
        run: npm run test:integration
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
```

### 2. プリコミットフック

```json
// package.json
{
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged",
      "pre-push": "npm run test:unit"
    }
  },
  "lint-staged": {
    "*.{js,jsx,ts,tsx}": ["eslint --fix", "prettier --write"],
    "*.{md,json}": ["prettier --write"]
  }
}
```

## デバッグ・トラブルシューティング

### 1. VS Code デバッグ設定

```json
// .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Next.js: debug server-side",
      "type": "node",
      "request": "attach",
      "port": 9229,
      "skipFiles": ["<node_internals>/**"]
    },
    {
      "name": "Next.js: debug client-side",
      "type": "chrome",
      "request": "launch",
      "url": "http://localhost:3000"
    }
  ]
}
```

### 2. ログ出力設定

```typescript
// lib/utils/logger.ts
export const logger = {
  debug: (message: string, meta?: any) => {
    if (process.env.NODE_ENV === "development") {
      console.debug(`[DEBUG] ${message}`, meta);
    }
  },

  info: (message: string, meta?: any) => {
    console.info(`[INFO] ${message}`, meta);
  },

  warn: (message: string, meta?: any) => {
    console.warn(`[WARN] ${message}`, meta);
  },

  error: (message: string, error?: Error) => {
    console.error(`[ERROR] ${message}`, error);
  },
};
```

### 3. よくある問題と解決方法

#### データベース接続エラー

```bash
# Prisma クライアント再生成
npx prisma generate

# マイグレーション状態確認
npx prisma migrate status

# データベースリセット（開発環境のみ）
npx prisma migrate reset
```

#### 型エラー

```bash
# TypeScript キャッシュクリア
rm -rf .next/cache
npm run type-check
```

#### パフォーマンス問題

```bash
# Next.js キャッシュクリア
rm -rf .next

# 依存関係再インストール
rm -rf node_modules package-lock.json
npm install
```

## 開発ワークフロー

### 1. ブランチ戦略

```
main
├── develop
│   ├── feature/account-management
│   ├── feature/journal-entry
│   └── bugfix/validation-error
└── hotfix/security-patch
```

### 2. コミットメッセージ規約

```
feat: 新機能追加
fix: バグ修正
docs: ドキュメント更新
style: コードスタイル修正
refactor: リファクタリング
test: テスト追加・修正
chore: その他の変更

例:
feat(account): 勘定科目階層表示機能を追加
fix(validation): 金額入力バリデーションを修正
docs(api): REST API仕様書を更新
```

### 3. プルリクエストプロセス

1. **機能ブランチ作成**
2. **実装・テスト**
3. **コードレビュー依頼**
4. **CI/CD パイプライン通過確認**
5. **マージ・デプロイ**
