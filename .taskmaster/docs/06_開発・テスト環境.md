# 開発・テスト環境

## 概要

Biz Clone の開発環境は、現代的な開発ツールと**TaskMaster による AI 支援開発手法**を採用し、効率的で品質の高い開発体験を提供します。  
**型安全性**と**自動化**を重視し、継続的な品質向上を実現しています。

## 開発環境構成

### 1. 必要なソフトウェア

#### 基本環境

- **Node.js** 20.x 以上
- **npm** または **Bun** （パッケージマネージャー）
- **Git** バージョン管理
- **PostgreSQL** 15.x 以上（ローカル開発用）

#### AI 支援開発環境

- **TaskMaster CLI** - AI 支援タスク管理システム
  ```bash
  npm install -g task-master-ai
  ```
- **Cursor IDE** - AI 統合開発環境（推奨）
- **MCP 対応エディタ** - TaskMaster との統合に対応

#### 推奨開発ツール

- **VS Code** - エディター（Cursor の代替）
- **Docker** - 開発環境統一
- **Supabase CLI** - Supabase 操作
- **Prisma CLI** - データベース管理

### 2. 開発環境セットアップ

#### プロジェクトクローン・初期設定

```bash
# リポジトリクローン
git clone <repository-url>
cd biz-clone

# 依存関係インストール
npm install
# または
bun install

# 環境変数設定
cp .env.example .env
# .env ファイルを編集して必要な値を設定
```

#### TaskMaster プロジェクト初期化

```bash
# TaskMaster プロジェクト初期化（初回のみ）
task-master init --name="Biz Clone" --description="日本企業向け会計システム"

# AI モデル設定（対話式）
task-master models --setup

# PRD解析によるタスク生成（初回のみ）
task-master parse-prd --input='.taskmaster/docs/prd.txt' --research --num-tasks=15

# 生成されたタスクの確認
task-master list
```

#### データベースセットアップ

```bash
# Prisma クライアント生成
npx prisma generate

# データベースマイグレーション
npx prisma migrate dev

# シードデータ投入（オプション）
npx prisma db seed
```

#### 開発サーバー起動

```bash
# 開発サーバー起動
npm run dev
# または
bun dev

# ブラウザで http://localhost:3000 にアクセス
```

## TaskMaster 統合開発ワークフロー

### 1. 開発セッション開始手順

#### Step 1: プロジェクト状況確認

```bash
# 現在のタスク状況を確認
task-master list

# 次に作業すべきタスクを確認
task-master next
```

#### Step 2: 作業対象タスクの分析

```bash
# タスクの詳細表示
task-master show <task-id>

# 複雑なタスクの場合は分解
task-master expand --id=<task-id> --research --force
```

#### Step 3: 実装作業

```bash
# タスクのステータスを作業中に変更
task-master set-status --id=<task-id> --status=in-progress

# サブタスクの実装過程を記録（推奨）
task-master update-subtask --id=<subtask-id> --prompt="実装開始
- 調査した内容...
- 実装方針..."
```

#### Step 4: 完了処理

```bash
# 実装完了時のステータス更新
task-master set-status --id=<task-id> --status=done

# 実装により影響を受ける将来タスクの更新
task-master update --from=<next-task-id> --prompt="実装変更の影響..."
```

### 2. AI 支援機能の活用

#### 複雑度分析

```bash
# プロジェクト全体の複雑度分析
task-master analyze-complexity --research --threshold=6

# 分析レポートの確認
task-master complexity-report
```

#### 研究支援機能

```bash
# 最新技術情報による支援を有効化
task-master expand --id=<task-id> --research
task-master add-task --prompt="新機能要件..." --research
task-master update-task --id=<task-id> --prompt="変更内容..." --research
```

#### 一括処理

```bash
# 全ての未分解タスクを一括分解
task-master expand --all --research --force

# 依存関係の検証・修正
task-master validate-dependencies
task-master fix-dependencies
```

## 環境変数設定

### 1. 必須環境変数

#### アプリケーション設定

```bash
# .env ファイル設定例
# データベース接続
DATABASE_URL="postgresql://user:password@localhost:5432/biz_clone_dev"
DIRECT_URL="postgresql://user:password@localhost:5432/biz_clone_dev"

# Supabase設定
NEXT_PUBLIC_SUPABASE_URL="your-supabase-url"
NEXT_PUBLIC_SUPABASE_ANON_KEY="your-supabase-anon-key"
SUPABASE_SERVICE_ROLE_KEY="your-service-role-key"

# 認証設定
NEXTAUTH_SECRET="your-secret-key"
NEXTAUTH_URL="http://localhost:3000"
```

#### TaskMaster AI 設定

```bash
# TaskMaster AI API キー（使用するプロバイダに応じて設定）
ANTHROPIC_API_KEY="your-anthropic-key"
OPENAI_API_KEY="your-openai-key"
PERPLEXITY_API_KEY="your-perplexity-key"
GOOGLE_API_KEY="your-google-key"

# その他のAIプロバイダ（オプション）
MISTRAL_API_KEY="your-mistral-key"
XAI_API_KEY="your-xai-key"
OPENROUTER_API_KEY="your-openrouter-key"

# Azure OpenAI（使用する場合）
AZURE_OPENAI_API_KEY="your-azure-key"
AZURE_OPENAI_ENDPOINT="https://your-resource.openai.azure.com"

# Ollama（ローカルLLM使用時）
OLLAMA_BASE_URL="http://localhost:11434/api"
```

**注意**: TaskMaster の設定（モデル選択、パラメータ等）は`.taskmaster/config.json`で管理され、`task-master models`コマンドで設定します。環境変数は API キーのみに使用します。

### 2. 開発環境別設定

#### ローカル開発

```bash
NODE_ENV=development
DEBUG=true
LOG_LEVEL=debug
TASKMASTER_LOG_LEVEL=debug
```

#### ステージング環境

```bash
NODE_ENV=staging
DEBUG=false
LOG_LEVEL=info
TASKMASTER_LOG_LEVEL=info
```

#### 本番環境

```bash
NODE_ENV=production
DEBUG=false
LOG_LEVEL=error
TASKMASTER_LOG_LEVEL=warn
```

## テスト戦略

### 1. テストピラミッド

```mermaid
graph TD
    E2E[E2E Tests<br/>Playwright<br/>TaskMaster統合テスト]
    INT[Integration Tests<br/>API・DB連携<br/>TaskMaster API テスト]
    UNIT[Unit Tests<br/>ビジネスロジック<br/>TaskMaster ユーティリティ]

    style E2E fill:#ffeb3b,color:#000
    style INT fill:#4caf50,color:#fff
    style UNIT fill:#2196f3,color:#fff

    E2E --> INT
    INT --> UNIT
```

### 2. テストの種類と責務

#### Unit Tests（単体テスト）

**場所**: `__tests__/unit/`  
**対象**: Service クラス、Utility 関数、TaskMaster 統合関数
**ツール**: Jest, Testing Library

```typescript
// __tests__/unit/services/AccountService.test.ts
describe("AccountService", () => {
  let accountService: AccountService;
  let mockRepository: jest.Mocked<IAccountRepository>;

  beforeEach(() => {
    mockRepository = {
      findById: jest.fn(),
      create: jest.fn(),
      // ...
    } as jest.Mocked<IAccountRepository>;

    accountService = new AccountService(mockRepository);
  });

  describe("createAccount", () => {
    it("正常な勘定科目データで作成できること", async () => {
      const accountData: AccountCreateDto = {
        accountCode: "TEST001",
        accountName: "テスト勘定科目",
        accountType: "資産",
        isDetail: true,
        isActive: true,
        sortOrder: 1,
      };

      mockRepository.create.mockResolvedValue({
        ...accountData,
        createdAt: new Date(),
        updatedAt: new Date(),
      } as Account);

      const result = await accountService.createAccount(accountData);

      expect(mockRepository.create).toHaveBeenCalledWith(accountData);
      expect(result.accountCode).toBe("TEST001");
    });

    it("無効な勘定科目コードでエラーになること", async () => {
      const invalidData: AccountCreateDto = {
        accountCode: "invalid-code",
        accountName: "テスト",
        accountType: "資産",
        isDetail: true,
        isActive: true,
        sortOrder: 1,
      };

      await expect(accountService.createAccount(invalidData)).rejects.toThrow(
        "勘定科目コードは3-10文字の英数字で入力してください"
      );
    });
  });
});
```

#### TaskMaster 統合テスト

```typescript
// __tests__/unit/taskmaster/TaskmasterIntegration.test.ts
describe("TaskMaster Integration", () => {
  describe("タスク管理機能", () => {
    it("タスクの作成から完了まで正常に動作すること", async () => {
      // TaskMasterのモック設定
      const mockTaskmaster = new MockTaskmaster();

      // タスク作成
      const taskId = await mockTaskmaster.addTask({
        prompt: "勘定科目作成機能のテスト実装",
        priority: "high",
      });

      expect(taskId).toBeDefined();

      // タスクの詳細確認
      const task = await mockTaskmaster.getTask(taskId);
      expect(task.status).toBe("pending");

      // ステータス更新
      await mockTaskmaster.setTaskStatus(taskId, "done");

      const updatedTask = await mockTaskmaster.getTask(taskId);
      expect(updatedTask.status).toBe("done");
    });
  });
});
```

#### Integration Tests（統合テスト）

**場所**: `__tests__/integration/`  
**対象**: API エンドポイント、データベース連携、TaskMaster API
**ツール**: Jest, Supertest

```typescript
// __tests__/integration/api/accounts.test.ts
describe("/api/accounts", () => {
  let app: NextApiHandler;
  let testDb: PrismaClient;

  beforeAll(async () => {
    // テスト用データベース準備
    testDb = new PrismaClient({
      datasources: { db: { url: process.env.TEST_DATABASE_URL } },
    });
    await testDb.$connect();
  });

  afterAll(async () => {
    await testDb.$disconnect();
  });

  beforeEach(async () => {
    // テストデータ初期化
    await testDb.account.deleteMany();
  });

  describe("POST /api/accounts", () => {
    it("勘定科目を作成できること", async () => {
      const accountData = {
        accountCode: "TEST001",
        accountName: "テスト勘定科目",
        accountType: "資産",
        isDetail: true,
        isActive: true,
        sortOrder: 1,
      };

      const response = await request(app)
        .post("/api/accounts")
        .send(accountData)
        .expect(201);

      expect(response.body).toMatchObject(accountData);

      // データベースに保存されていることを確認
      const saved = await testDb.account.findUnique({
        where: { accountCode: "TEST001" },
      });
      expect(saved).toBeTruthy();
    });
  });
});
```

#### E2E Tests（End-to-End テスト）

**場所**: `__tests__/e2e/`  
**対象**: ユーザーフロー全体、TaskMaster 連携フロー
**ツール**: Playwright

```typescript
// __tests__/e2e/account-management.spec.ts
import { test, expect } from "@playwright/test";

test.describe("勘定科目管理", () => {
  test("勘定科目の作成から削除までのフロー", async ({ page }) => {
    // ログイン
    await page.goto("/login");
    await page.fill("[data-testid=email]", "test@example.com");
    await page.fill("[data-testid=password]", "password");
    await page.click("[data-testid=login-button]");

    // 勘定科目管理画面に遷移
    await page.goto("/master/accounts");
    await expect(page).toHaveTitle(/勘定科目管理/);

    // 新規作成
    await page.click("[data-testid=add-account-button]");
    await page.fill("[data-testid=account-code]", "TEST001");
    await page.fill("[data-testid=account-name]", "テスト勘定科目");
    await page.selectOption("[data-testid=account-type]", "資産");
    await page.click("[data-testid=save-button]");

    // 作成確認
    await expect(page.locator("[data-testid=success-message]")).toBeVisible();
    await expect(page.locator("text=TEST001")).toBeVisible();

    // 編集
    await page.click("[data-testid=edit-TEST001]");
    await page.fill("[data-testid=account-name]", "テスト勘定科目（更新）");
    await page.click("[data-testid=save-button]");

    // 更新確認
    await expect(page.locator("text=テスト勘定科目（更新）")).toBeVisible();

    // 削除
    await page.click("[data-testid=delete-TEST001]");
    await page.click("[data-testid=confirm-delete]");

    // 削除確認
    await expect(page.locator("text=TEST001")).not.toBeVisible();
  });
});
```

#### TaskMaster E2E テスト

```typescript
// __tests__/e2e/taskmaster-workflow.spec.ts
import { test, expect } from "@playwright/test";

test.describe("TaskMaster統合ワークフロー", () => {
  test("新機能開発の完全なワークフロー", async ({ page }) => {
    // TaskMasterダッシュボード
    await page.goto("/taskmaster");

    // 新タスク作成
    await page.click("[data-testid=add-task-button]");
    await page.fill("[data-testid=task-prompt]", "新しい帳票機能の実装");
    await page.check("[data-testid=research-enabled]");
    await page.click("[data-testid=create-task]");

    // タスク分解
    const taskId = await page.textContent("[data-testid=new-task-id]");
    await page.click(`[data-testid=expand-${taskId}]`);
    await page.check("[data-testid=force-expand]");
    await page.click("[data-testid=expand-button]");

    // サブタスクの確認
    await expect(page.locator("[data-testid=subtasks]")).toBeVisible();

    // 実装進捗の記録
    await page.click("[data-testid=first-subtask]");
    await page.fill("[data-testid=progress-notes]", "実装開始しました...");
    await page.click("[data-testid=update-subtask]");

    // ステータス更新
    await page.selectOption("[data-testid=status-select]", "done");
    await page.click("[data-testid=update-status]");

    expect(await page.textContent("[data-testid=task-status]")).toBe("done");
  });
});
```

### 3. テスト実行コマンド

#### 基本テスト実行

```bash
# 全テスト実行
npm test

# ユニットテストのみ
npm run test:unit

# 統合テストのみ
npm run test:integration

# E2Eテストのみ
npm run test:e2e
```

#### TaskMaster 統合テスト

```bash
# TaskMaster機能のテスト
npm run test:taskmaster

# TaskMaster統合フローのテスト
npm run test:taskmaster:e2e

# TaskMaster設定の検証
task-master validate-dependencies
```

#### 高度なテスト実行

```bash
# カバレッジ付きテスト
npm run test:coverage

# ウォッチモード
npm run test:watch

# デバッグモード
npm run test:debug

# 並列実行
npm run test:parallel
```

### 4. CI/CD パイプライン

#### GitHub Actions 設定

```yaml
# .github/workflows/test.yml
name: Test Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: biz_clone_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install TaskMaster
        run: npm install -g task-master-ai

      - name: Setup TaskMaster
        run: |
          task-master models --set-main=gpt-4o
          task-master models --set-research=perplexity-llama-3.1-sonar-small-128k-online
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}

      - name: Setup Database
        run: |
          npx prisma generate
          npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/biz_clone_test

      - name: Run Unit Tests
        run: npm run test:unit

      - name: Run Integration Tests
        run: npm run test:integration
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/biz_clone_test

      - name: Run TaskMaster Tests
        run: npm run test:taskmaster
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}

      - name: Install Playwright
        run: npx playwright install

      - name: Run E2E Tests
        run: npm run test:e2e
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/biz_clone_test

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: test-results/
```

## 開発ツール統合

### 1. エディタ設定

#### Cursor IDE（推奨）

```json
// .cursor/settings.json
{
  "taskmaster.enabled": true,
  "taskmaster.mcp.enabled": true,
  "taskmaster.autoUpdate": true,
  "taskmaster.showProgress": true,
  "typescript.preferences.includePackageJsonAutoImports": "on",
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true,
    "source.organizeImports": true
  },
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode"
}
```

#### VS Code 設定

```json
// .vscode/settings.json
{
  "typescript.preferences.includePackageJsonAutoImports": "on",
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true,
    "source.organizeImports": true
  },
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "taskmaster.integration.enabled": true
}
```

#### 推奨拡張機能

```json
// .vscode/extensions.json
{
  "recommendations": [
    "esbenp.prettier-vscode",
    "bradlc.vscode-tailwindcss",
    "ms-playwright.playwright",
    "prisma.prisma",
    "taskmaster.vscode-extension"
  ]
}
```

### 2. デバッグ設定

#### Launch.json 設定

```json
// .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Next.js: debug server-side",
      "type": "node",
      "request": "attach",
      "port": 9229,
      "skipFiles": ["<node_internals>/**"]
    },
    {
      "name": "Next.js: debug client-side",
      "type": "chrome",
      "request": "launch",
      "url": "http://localhost:3000"
    },
    {
      "name": "TaskMaster Debug",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/node_modules/.bin/task-master",
      "args": ["list"],
      "env": {
        "TASKMASTER_LOG_LEVEL": "debug"
      }
    }
  ]
}
```

## パフォーマンス最適化

### 1. 開発環境の最適化

#### Next.js 最適化

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    optimizePackageImports: ["@radix-ui/react-icons"],
    turbo: {
      rules: {
        "*.svg": {
          loaders: ["@svgr/webpack"],
          as: "*.js",
        },
      },
    },
  },
  // 開発時のバンドル最適化
  webpack: (config, { dev, isServer }) => {
    if (dev && !isServer) {
      config.optimization.splitChunks = {
        chunks: "all",
        cacheGroups: {
          vendor: {
            test: /[\\/]node_modules[\\/]/,
            name: "vendors",
            chunks: "all",
          },
        },
      };
    }
    return config;
  },
};

module.exports = nextConfig;
```

#### TaskMaster 最適化

```bash
# TaskMaster キャッシュクリア（動作が重い場合）
task-master --clear-cache

# 複雑度分析の結果をキャッシュ
task-master analyze-complexity --cache

# 大量タスクの効率的な処理
task-master list --limit=50 --offset=0
```

### 2. データベース最適化

#### Prisma 最適化

```javascript
// lib/database/prisma.ts
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma = globalForPrisma.prisma ?? new PrismaClient({
  log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
  // 開発環境でのコネクションプール最適化
  datasources: {
    db: {
      url: process.env.DATABASE_URL,
    },
  },
});

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;
```

## トラブルシューティング

### 1. 一般的な問題と解決策

#### TaskMaster 関連

```bash
# TaskMasterが認識されない
npm install -g task-master-ai
task-master --version

# API キーエラー
task-master models --setup
# または環境変数を確認
echo $OPENAI_API_KEY

# タスクファイルの破損
task-master validate-dependencies
task-master fix-dependencies

# MCP接続エラー（Cursor使用時）
# Cursorを再起動し、MCP設定を確認
```

#### データベース関連

```bash
# マイグレーションエラー
npx prisma migrate reset --force
npx prisma migrate dev

# 接続エラー
npx prisma db pull
npx prisma generate
```

#### Next.js 関連

```bash
# ビルドエラー
rm -rf .next
npm run build

# 型エラー
npx tsc --noEmit
```

### 2. ログ確認とデバッグ

#### TaskMaster ログ

```bash
# デバッグログの有効化
export TASKMASTER_LOG_LEVEL=debug
task-master list

# ログファイルの確認
tail -f .taskmaster/logs/taskmaster.log
```

#### アプリケーションログ

```bash
# 開発サーバーのログレベル調整
export DEBUG=true
export LOG_LEVEL=debug
npm run dev
```

### 3. パフォーマンス問題

#### 重いタスク処理

```bash
# タスクを小さい単位に分解
task-master expand --id=<heavy-task-id> --num=10 --force

# 複雑度分析で重いタスクを特定
task-master analyze-complexity --threshold=8
```

#### データベースクエリの最適化

```typescript
// Prismaクエリの最適化例
const accounts = await prisma.account.findMany({
  select: {
    id: true,
    accountCode: true,
    accountName: true,
    // 必要なフィールドのみ選択
  },
  where: {
    isActive: true,
  },
  orderBy: {
    sortOrder: "asc",
  },
  take: 100, // ページネーション
});
```

## 更新履歴

| 日付       | バージョン | 内容                                         |
| ---------- | ---------- | -------------------------------------------- |
| 2025-01-21 | 2.0.0      | TaskMaster 統合、AI 支援開発環境構築手順追加 |
| 2025-06-12 | 1.2.0      | 型システム統一対応、テスト戦略強化           |
| 2025-01-09 | 1.0.0      | 初版作成                                     |

---

📚 **Note**: このドキュメントは TaskMaster による AI 支援開発手法を前提としています。従来の手動開発手法との違いを理解し、効率的な開発環境構築を行ってください。
