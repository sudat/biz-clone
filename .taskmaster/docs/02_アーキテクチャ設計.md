# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

## ãªãœ 4 å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãªã®ã‹ï¼Ÿ

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£é¸æŠã®èƒŒæ™¯

ä¼šè¨ˆã‚·ã‚¹ãƒ†ãƒ ã«ã¯è¤‡é›‘ãªè¦æ±‚ãŒã‚ã‚Šã¾ã™ï¼š

- **è¤‡å¼ç°¿è¨˜ã®ãƒ«ãƒ¼ãƒ«**: å€Ÿæ–¹ã¨è²¸æ–¹ã®åˆè¨ˆãŒå¿…ãšä¸€è‡´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- **ç¨å‹™å‡¦ç†**: æ¶ˆè²»ç¨è¨ˆç®—ã€æºæ³‰ç¨è¨ˆç®—ãªã©æ³•å¾‹ã«åŸºã¥ãè¨ˆç®—
- **ç›£æŸ»å¯¾å¿œ**: ã„ã¤ã€èª°ãŒã€ä½•ã‚’å¤‰æ›´ã—ãŸã‹ã®è¨˜éŒ²ãŒå¿…è¦
- **é•·æœŸä¿ç®¡**: ä¼šè¨ˆãƒ‡ãƒ¼ã‚¿ã¯ 7 å¹´é–“ä¿ç®¡ã™ã‚‹æ³•çš„ç¾©å‹™ãŒã‚ã‚‹

ã“ã‚Œã‚‰ã®è¤‡é›‘ã•ã‚’æ•´ç†ã™ã‚‹ãŸã‚ã«ã€**è²¬å‹™ã‚’ 4 ã¤ã®å±¤ã«åˆ†é›¢**ã—ã¾ã™ã€‚

### 4 å±¤ã«åˆ†ã‘ã‚‹ç†ç”±

#### 1 å±¤ã ã‘ã®å ´åˆã®å•é¡Œ

```typescript
// ã™ã¹ã¦ãŒæ··åœ¨ã—ãŸæ‚ªã„ä¾‹
function createAccount() {
  // ç”»é¢è¡¨ç¤ºã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‡¦ç†ãŒæ··åœ¨
  const form = document.getElementById("form"); // ç”»é¢
  const code = form.value; // å…¥åŠ›
  if (code.length < 3) throw new Error("ç„¡åŠ¹"); // ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«
  await db.query("INSERT..."); // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
  alert("æˆåŠŸ"); // ç”»é¢
}
```

#### 4 å±¤ã«åˆ†ã‘ãŸå ´åˆã®åˆ©ç‚¹

```typescript
// è²¬å‹™ãŒæ˜ç¢ºã«åˆ†é›¢ã•ã‚ŒãŸè‰¯ã„ä¾‹

// ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤: ç”»é¢è¡¨ç¤ºã®ã¿
function AccountForm() {
  return <form onSubmit={handleSubmit}>...</form>;
}

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤: å‡¦ç†ã®æµã‚Œã®ã¿
async function createAccount(data) {
  return await accountService.create(data);
}

// ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤: ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã®ã¿
class AccountService {
  validate(code) {
    if (code.length < 3) throw new Error("ç„¡åŠ¹");
  }
}

// ã‚¤ãƒ³ãƒ•ãƒ©å±¤: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã®ã¿
class AccountRepository {
  async save(account) {
    return await db.account.create(account);
  }
}
```

## å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

Biz Clone ã¯ã€**ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ã‚’æ¡ç”¨ã—ã¦ãŠã‚Šã€å„å±¤ã®è²¬å‹™ã‚’æ˜ç¢ºã«åˆ†é›¢ã—ã¦ã„ã¾ã™ã€‚

```mermaid
graph TB
    %% ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤
    subgraph "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤"
        UI["Next.js Pages (app/)"]
        COMP["React Components (components/)"]
    end

    %% ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤
    subgraph "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤"
        ACTION["Server Actions (app/lib/actions/)"]
        SERVICE["Services (lib/services/)"]
        DAL["DataAccessLayer (lib/data-access/)"]
    end

    %% ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤
    subgraph "ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤"
        ENTITY["Entities (lib/types/)"]
        SCHEMA["Validation Schemas (lib/schemas/)"]
        INTERFACE["Repository Interfaces (lib/repositories/interfaces/)"]
    end

    %% ã‚¤ãƒ³ãƒ•ãƒ©å±¤
    subgraph "ã‚¤ãƒ³ãƒ•ãƒ©å±¤"
        REPO["Repository Implementations (lib/repositories/implementations/)"]
        FACTORY["Factories (lib/repositories/factory/)"]
        BASE["Base Repository (lib/repositories/base/)"]
        DB["Database (Prisma + Supabase)"]
    end

    %% é–¢ä¿‚æ€§
    UI --> COMP
    UI --> ACTION
    ACTION --> SERVICE
    SERVICE --> DAL
    DAL --> REPO
    REPO --> FACTORY
    FACTORY --> BASE
    BASE --> DB
    SERVICE --> ENTITY
    REPO --> INTERFACE
    COMP --> SCHEMA
```

## å„å±¤ã®è©³ç´°ãªè²¬å‹™ã¨å®Ÿè£…

### 1. ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤ - ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®æ¥ç‚¹ã€

**å ´æ‰€**: `app/`, `components/`  
**å½¹å‰²**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã‚‹ç”»é¢ã¨æ“ä½œã‚’æ‹…å½“

#### ãªãœã“ã®å±¤ãŒå¿…è¦ã‹ï¼Ÿ

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œï¼ˆã‚¯ãƒªãƒƒã‚¯ã€å…¥åŠ›ï¼‰ã‚’å—ã‘å–ã‚‹
- æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†ã‹ã‚Šã‚„ã™ã„å½¢ã§è¡¨ç¤ºã™ã‚‹
- ç•°ãªã‚‹ãƒ‡ãƒã‚¤ã‚¹ï¼ˆPCã€ã‚¹ãƒãƒ›ï¼‰ã¸ã®å¯¾å¿œ

#### å…·ä½“çš„ãªå®Ÿè£…ä¾‹

```typescript
// app/master/accounts/page.tsx
// å‹˜å®šç§‘ç›®ã®ä¸€è¦§ç”»é¢
export default async function AccountsPage() {
  // ã“ã®å±¤ã§ã¯ã€Œç”»é¢ã«ä½•ã‚’è¡¨ç¤ºã™ã‚‹ã‹ã€ã®ã¿ã‚’æ±ºå®š
  const accounts = await getAccounts(); // ãƒ‡ãƒ¼ã‚¿å–å¾—ã¯ä»–ã®å±¤ã«å§”è¨—

  return (
    <div>
      <h1>å‹˜å®šç§‘ç›®ç®¡ç†</h1>
      <AccountList accounts={accounts} />
      <CreateAccountButton />
    </div>
  );
}
```

```typescript
// components/accounting/AccountForm.tsx
// å‹˜å®šç§‘ç›®ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
export function AccountForm({ onSubmit }: Props) {
  // ã“ã®å±¤ã§ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ã‚„ã™ã„å½¢ã€ã‚’æä¾›
  return (
    <form onSubmit={onSubmit}>
      <Input label="å‹˜å®šç§‘ç›®ã‚³ãƒ¼ãƒ‰" name="accountCode" />
      <Input label="å‹˜å®šç§‘ç›®å" name="accountName" />
      <Select label="ç§‘ç›®åŒºåˆ†" name="accountType" />
      <Button type="submit">ä½œæˆ</Button>
    </form>
  );
}
```

#### ã“ã®å±¤ã®è²¬å‹™

- âœ… **ã‚„ã‚‹ã“ã¨**: ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã®é…ç½®ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
- âŒ **ã‚„ã‚‰ãªã„ã“ã¨**: ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã®åˆ¤å®šã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä¿å­˜

### 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ - ã€Œæ¥­å‹™ã®æµã‚Œã‚’åˆ¶å¾¡ã€

**å ´æ‰€**: `app/lib/actions/`, `lib/services/`, `lib/data-access/`  
**å½¹å‰²**: æ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã®æµã‚Œã‚’çµ„ã¿ç«‹ã¦ã‚‹

#### ãªãœã“ã®å±¤ãŒå¿…è¦ã‹ï¼Ÿ

- è¤‡æ•°ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’çµ„ã¿åˆã‚ã›ãŸå‡¦ç†
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆè¤‡æ•°ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’åŒæ™‚ã«æ›´æ–°ï¼‰
- å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºèª¿æ•´

#### TASK23 ã§å®Ÿè£…ã—ãŸé‡è¦ãªæ”¹å–„

**çµ±ä¸€ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ (`DataAccessLayer`)**

```typescript
// lib/data-access/index.ts
export class DataAccessLayer {
  private static instance: DataAccessLayer;
  private repositoryContainer: IRepositoryContainer;
  private serviceContainer: IServiceContainer;

  // ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ä¸€å…ƒç®¡ç†
  static getInstance(): DataAccessLayer {
    if (!DataAccessLayer.instance) {
      DataAccessLayer.instance = new DataAccessLayer();
    }
    return DataAccessLayer.instance;
  }

  // å…¨ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’çµ±ä¸€çš„ã«å–å¾—
  getServices(): IServiceContainer {
    return this.serviceContainer;
  }
}
```

#### å…·ä½“çš„ãªå®Ÿè£…ä¾‹

```typescript
// app/lib/actions/master-unified.ts
export async function createAccountAction(formData: FormData) {
  try {
    // 1. ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼ˆãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã‹ã‚‰ï¼‰
    const data = extractFormData(formData, accountCreateSchema);

    // 2. ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ã®å–å¾—
    const dal = DataAccessLayer.getInstance();
    const { account: accountService } = dal.getServices();

    // 3. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã«å§”è¨—ï¼‰
    const result = await accountService.createAccount(data);

    // 4. æˆåŠŸæ™‚ã®å‡¦ç†
    return { success: true, data: result };
  } catch (error) {
    // 5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    return { success: false, error: error.message };
  }
}
```

#### ã“ã®å±¤ã®è²¬å‹™

- âœ… **ã‚„ã‚‹ã“ã¨**: å‡¦ç†ã®é †åºæ±ºå®šã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
- âŒ **ã‚„ã‚‰ãªã„ã“ã¨**: å…·ä½“çš„ãªãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è©³ç´°æ“ä½œ

### 3. ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ - ã€Œãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã®ä¸­æ ¸ã€

**å ´æ‰€**: `lib/types/`, `lib/schemas/`, `lib/repositories/interfaces/`  
**å½¹å‰²**: ä¼šè¨ˆæ¥­å‹™ã®ãƒ«ãƒ¼ãƒ«ã¨çŸ¥è­˜ã‚’å®šç¾©

#### ãªãœã“ã®å±¤ãŒå¿…è¦ã‹ï¼Ÿ

- è¤‡å¼ç°¿è¨˜ã®ãƒ«ãƒ¼ãƒ«ã€Œå€Ÿæ–¹ = è²¸æ–¹ã€ã‚’ä¿è¨¼
- å‹˜å®šç§‘ç›®ã®éšå±¤æ§‹é€ ãƒ«ãƒ¼ãƒ«
- ç¨å‹™è¨ˆç®—ã®æ­£ç¢ºæ€§ä¿è¨¼

#### å…·ä½“çš„ãªå®Ÿè£…ä¾‹

**ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å®šç¾©**

```typescript
// lib/types/account.ts
export interface Account {
  accountCode: string; // å‹˜å®šç§‘ç›®ã‚³ãƒ¼ãƒ‰
  accountName: string; // å‹˜å®šç§‘ç›®å
  accountType: string; // ç§‘ç›®åŒºåˆ†ï¼ˆè³‡ç”£ã€è² å‚µã€è³‡æœ¬ã€åç›Šã€è²»ç”¨ï¼‰
  isDetail: boolean; // æ˜ç´°ç§‘ç›®ãƒ•ãƒ©ã‚°
  parentAccountCode?: string; // è¦ªç§‘ç›®ã‚³ãƒ¼ãƒ‰
  children?: Account[]; // å­ç§‘ç›®
}

// ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«: è¦ªå­é–¢ä¿‚ã®æ•´åˆæ€§
export function validateAccountHierarchy(account: Account): boolean {
  if (account.parentAccountCode && account.isDetail) {
    throw new Error("è¦ªç§‘ç›®ã‚’æŒã¤ç§‘ç›®ã¯æ˜ç´°ç§‘ç›®ã«ã§ãã¾ã›ã‚“");
  }
  return true;
}
```

**ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ¼ãƒ**

```typescript
// lib/schemas/master/account.ts
export const accountCreateSchema = z.object({
  accountCode: z
    .string()
    .min(3, "å‹˜å®šç§‘ç›®ã‚³ãƒ¼ãƒ‰ã¯3æ–‡å­—ä»¥ä¸Šå¿…è¦ã§ã™")
    .max(10, "å‹˜å®šç§‘ç›®ã‚³ãƒ¼ãƒ‰ã¯10æ–‡å­—ä»¥å†…ã§ã™")
    .regex(/^[A-Z0-9]+$/, "è‹±æ•°å­—ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™"),

  accountName: z
    .string()
    .min(1, "å‹˜å®šç§‘ç›®åã¯å¿…é ˆã§ã™")
    .max(50, "å‹˜å®šç§‘ç›®åã¯50æ–‡å­—ä»¥å†…ã§ã™"),

  accountType: z.enum(["è³‡ç”£", "è² å‚µ", "è³‡æœ¬", "åç›Š", "è²»ç”¨"]),
});
```

**Repository ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**

```typescript
// lib/repositories/interfaces/IAccountRepository.ts
export interface IAccountRepository {
  // åŸºæœ¬æ“ä½œ
  findById(id: string): Promise<Account | null>;
  create(account: AccountCreateDto): Promise<Account>;

  // ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ç‰¹åŒ–ã®æ“ä½œ
  findByAccountType(type: string): Promise<Account[]>;
  validateAccountCode(code: string): Promise<boolean>;
  canDeleteAccount(id: string): Promise<boolean>;

  // éšå±¤æ§‹é€ å°‚ç”¨ã®æ“ä½œ
  getAccountHierarchy(): Promise<AccountHierarchy[]>;
  moveAccount(accountId: string, newParentId: string): Promise<void>;
}
```

#### ã“ã®å±¤ã®è²¬å‹™

- âœ… **ã‚„ã‚‹ã“ã¨**: ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã®å®šç¾©ã€ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å®šç¾©ã€åˆ¶ç´„æ¡ä»¶ã®è¨­å®š
- âŒ **ã‚„ã‚‰ãªã„ã“ã¨**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã€ç”»é¢è¡¨ç¤ºã€å…·ä½“çš„ãªå‡¦ç†ãƒ•ãƒ­ãƒ¼

### 4. ã‚¤ãƒ³ãƒ•ãƒ©å±¤ - ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®æ¥ç¶šã€

**å ´æ‰€**: `lib/repositories/implementations/`, `lib/repositories/base/`, `prisma/`  
**å½¹å‰²**: ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ã¨å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¨ã®æ¥ç¶š

#### ãªãœã“ã®å±¤ãŒå¿…è¦ã‹ï¼Ÿ

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆPostgreSQLï¼‰ã¸ã®å®Ÿéš›ã®ã‚¢ã‚¯ã‚»ã‚¹
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
- å¤–éƒ¨ APIï¼ˆSupabase Authï¼‰ã¨ã®é€£æº

#### TASK23 ã§å®Ÿè£…ã—ãŸé‡è¦ãªæ”¹å–„

**BaseRepository ãƒ‘ã‚¿ãƒ¼ãƒ³**

```typescript
// lib/repositories/base/BaseRepository.ts
export abstract class BaseRepository<T, CreateDto, UpdateDto> {
  constructor(protected prisma: PrismaClient) {}

  // å…¨ãƒªãƒã‚¸ãƒˆãƒªå…±é€šã®åŸºæœ¬æ“ä½œ
  async findById(id: string): Promise<T | null> {
    try {
      const result = await this.prisma[this.getModelName()].findUnique({
        where: { [this.getIdField()]: id },
      });
      return result ? this.mapToEntity(result) : null;
    } catch (error) {
      this.handleError("findById", error);
      throw error;
    }
  }

  // å­ã‚¯ãƒ©ã‚¹ã§å®Ÿè£…å¿…é ˆã®ãƒ¡ã‚½ãƒƒãƒ‰
  protected abstract getModelName(): string;
  protected abstract mapToEntity(data: any): T;
  protected abstract getIdField(): string;
}
```

**å…·ä½“çš„ãª Repository å®Ÿè£…**

```typescript
// lib/repositories/implementations/AccountRepository.ts
export class AccountRepository
  extends BaseRepository<Account, AccountCreateDto, AccountUpdateDto>
  implements IAccountRepository
{
  protected getModelName(): string {
    return "account"; // Prismaã®ãƒ¢ãƒ‡ãƒ«å
  }

  protected getIdField(): string {
    return "accountCode"; // ä¸»ã‚­ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
  }

  protected mapToEntity(data: any): Account {
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã® snake_case ã‹ã‚‰ TypeScript ã® camelCase ã«å¤‰æ›
    return {
      accountCode: data.account_code,
      accountName: data.account_name,
      accountType: data.account_type,
      isDetail: data.is_detail,
      // ...ãã®ä»–ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    };
  }

  // å‹˜å®šç§‘ç›®å›ºæœ‰ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
  async findByAccountType(accountType: string): Promise<Account[]> {
    const results = await this.prisma.account.findMany({
      where: { account_type: accountType, is_active: true },
      orderBy: { sort_order: "asc" },
    });
    return results.map((data) => this.mapToEntity(data));
  }

  // è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«: å‰Šé™¤å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯
  async canDeleteAccount(accountCode: string): Promise<boolean> {
    // å­ç§‘ç›®ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const childCount = await this.prisma.account.count({
      where: { parent_account_code: accountCode },
    });

    // ä»•è¨³ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const journalCount = await this.prisma.journalDetail.count({
      where: { account_code: accountCode },
    });

    return childCount === 0 && journalCount === 0;
  }
}
```

**Factory ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹ä¾å­˜æ€§ç®¡ç†**

```typescript
// lib/repositories/factory/RepositoryFactory.ts
export class RepositoryFactory implements IRepositoryFactory {
  constructor(private prisma: PrismaClient) {}

  createAccountRepository(): IAccountRepository {
    return new AccountRepository(this.prisma);
  }

  createPartnerRepository(): IPartnerRepository {
    return new PartnerRepository(this.prisma);
  }

  // ã™ã¹ã¦ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ä¸€æ‹¬ç”Ÿæˆ
  createContainer(): IRepositoryContainer {
    return {
      account: this.createAccountRepository(),
      partner: this.createPartnerRepository(),
      analysisCode: this.createAnalysisCodeRepository(),
      journal: this.createJournalRepository(),
    };
  }
}
```

#### ã“ã®å±¤ã®è²¬å‹™

- âœ… **ã‚„ã‚‹ã“ã¨**: SQL ã‚¯ã‚¨ãƒªå®Ÿè¡Œã€ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- âŒ **ã‚„ã‚‰ãªã„ã“ã¨**: ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã®åˆ¤å®šã€ç”»é¢è¡¨ç¤ºã€å‡¦ç†ãƒ•ãƒ­ãƒ¼ã®åˆ¶å¾¡

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼: å®Ÿéš›ã®å‡¦ç†ã®æµã‚Œ

### 1. èª­ã¿å–ã‚Šå‡¦ç†ï¼ˆQueryï¼‰- å‹˜å®šç§‘ç›®ä¸€è¦§ã®è¡¨ç¤º

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Page as ãƒšãƒ¼ã‚¸(ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤)
    participant Action as Server Action(ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤)
    participant Service as AccountService(ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤)
    participant Interface as IAccountRepository(ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤)
    participant Repo as AccountRepository(ã‚¤ãƒ³ãƒ•ãƒ©å±¤)
    participant DB as PostgreSQL(ã‚¤ãƒ³ãƒ•ãƒ©å±¤)

    User->>Page: å‹˜å®šç§‘ç›®ä¸€è¦§ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹
    Page->>Action: getAccounts() å‘¼ã³å‡ºã—
    Action->>Service: service.getAllAccounts()
    Service->>Interface: repository.findAll()
    Interface->>Repo: å®Ÿè£…ã‚¯ãƒ©ã‚¹ã®findAll()
    Repo->>DB: SELECT * FROM accounts WHERE is_active = true
    DB-->>Repo: å‹˜å®šç§‘ç›®ãƒ‡ãƒ¼ã‚¿ï¼ˆsnake_caseï¼‰
    Repo-->>Interface: Account[]ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆcamelCaseï¼‰
    Interface-->>Service: Account[]ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
    Service-->>Action: Account[]ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
    Action-->>Page: Account[]ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
    Page-->>User: å‹˜å®šç§‘ç›®ä¸€è¦§è¡¨ç¤º
```

### 2. æ›¸ãè¾¼ã¿å‡¦ç†ï¼ˆCommandï¼‰- æ–°ã—ã„å‹˜å®šç§‘ç›®ã®ä½œæˆ

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Form as ãƒ•ã‚©ãƒ¼ãƒ (ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤)
    participant Action as Server Action(ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤)
    participant Service as AccountService(ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤)
    participant Interface as IAccountRepository(ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤)
    participant Repo as AccountRepository(ã‚¤ãƒ³ãƒ•ãƒ©å±¤)
    participant DB as PostgreSQL(ã‚¤ãƒ³ãƒ•ãƒ©å±¤)

    User->>Form: ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ãƒ»é€ä¿¡
    Form->>Action: createAccountAction(formData)

    Note over Action: FormData â†’ DTOå¤‰æ›<br/>ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

    Action->>Service: service.createAccount(dto)

    Note over Service: ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«æ¤œè¨¼<br/>é‡è¤‡ãƒã‚§ãƒƒã‚¯<br/>éšå±¤æ§‹é€ æ¤œè¨¼

    Service->>Interface: repository.create(dto)
    Interface->>Repo: å®Ÿè£…ã‚¯ãƒ©ã‚¹ã®create()

    Note over Repo: DTO â†’ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å½¢å¼å¤‰æ›<br/>ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹

    Repo->>DB: BEGIN; INSERT INTO accounts...; COMMIT;
    DB-->>Repo: ä½œæˆæˆåŠŸ + æ–°ã—ã„ãƒ¬ã‚³ãƒ¼ãƒ‰
    Repo-->>Interface: Accountã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
    Interface-->>Service: Accountã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
    Service-->>Action: ä½œæˆçµæœ
    Action-->>Form: æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    Form-->>User: ã€Œå‹˜å®šç§‘ç›®ã‚’ä½œæˆã—ã¾ã—ãŸã€
```

## TASK23 ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹æ”¹å–„ç‚¹

### æ”¹å–„å‰ã®å•é¡Œ

```typescript
// æ”¹å–„å‰: å„æ‰€ã«ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ¼ãƒ‰ãŒæ•£åœ¨
async function createAccount(data) {
  // ç›´æ¥Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨
  const account = await prisma.account.create({
    data: {
      account_code: data.accountCode, // æ‰‹å‹•ã§snake_caseå¤‰æ›
      account_name: data.accountName,
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒä¸çµ±ä¸€
    },
  });
}
```

### æ”¹å–„å¾Œã®çµ±ä¸€ã•ã‚ŒãŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```typescript
// æ”¹å–„å¾Œ: çµ±ä¸€ã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³
async function createAccount(data: AccountCreateDto) {
  // 1. ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ã‚’çµŒç”±
  const dal = DataAccessLayer.getInstance();
  const { account: accountService } = dal.getServices();

  // 2. ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ
  const result = await accountService.createAccount(data);

  // 3. å†…éƒ¨çš„ã«ã¯Repository â†’ Database ã®æµã‚Œã§å®Ÿè¡Œ
  return result;
}
```

### å®Ÿç¾ã•ã‚ŒãŸå…·ä½“çš„ãªãƒ¡ãƒªãƒƒãƒˆ

#### 1. ä¸€è²«æ€§ã®å‘ä¸Š

- å…¨ã¦ã® ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãŒ `DataAccessLayer` çµŒç”±ã§çµ±ä¸€
- `BaseRepository` ã«ã‚ˆã‚Šå…±é€šæ“ä½œã®æ¨™æº–åŒ–
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€

#### 2. ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã®å‘ä¸Š

- ãƒ¢ãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒªã§å˜ä½“ãƒ†ã‚¹ãƒˆå¯èƒ½
- å±¤ã”ã¨ã®ç‹¬ç«‹ã—ãŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®ç¶²ç¾…çš„å®Ÿè£…

#### 3. ä¿å®ˆæ€§ã®å‘ä¸Š

- æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®å½±éŸ¿ç¯„å›²ãŒæ˜ç¢º
- ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«å¤‰æ›´æ™‚ã®ä¿®æ­£ç®‡æ‰€ãŒç‰¹å®šå¯èƒ½
- ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡æ’é™¤

#### 4. ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã®å‘ä¸Š

- æ–°ã—ã„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¿½åŠ ãŒå®¹æ˜“
- ç•°ãªã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ç§»è¡ŒãŒå¯èƒ½
- ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹åŒ–ã¸ã®æº–å‚™

## è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®è©³ç´°

### 1. Repository ãƒ‘ã‚¿ãƒ¼ãƒ³

**ç›®çš„**: ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‹ã‚‰åˆ†é›¢

```typescript
// ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ï¼‰
interface IAccountRepository {
  findByCode(code: string): Promise<Account | null>;
}

// å®Ÿè£…ï¼ˆã‚¤ãƒ³ãƒ•ãƒ©å±¤ï¼‰
class AccountRepository implements IAccountRepository {
  async findByCode(code: string): Promise<Account | null> {
    // å…·ä½“çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹
  }
}

// ä½¿ç”¨ï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼‰
class AccountService {
  constructor(private repository: IAccountRepository) {
    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã®ã¿ä¾å­˜
  }
}
```

### 2. Factory ãƒ‘ã‚¿ãƒ¼ãƒ³

**ç›®çš„**: è¤‡é›‘ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆã®éš è”½

```typescript
// ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨çµ„ã¿åˆã‚ã›
class RepositoryFactory {
  private static instance: RepositoryFactory;

  static getInstance(): RepositoryFactory {
    if (!this.instance) {
      this.instance = new RepositoryFactory(new PrismaClient());
    }
    return this.instance;
  }
}
```

### 3. Dependency Injection ãƒ‘ã‚¿ãƒ¼ãƒ³

**ç›®çš„**: ä¾å­˜é–¢ä¿‚ã®çµåˆåº¦ã‚’ä¸‹ã’ã‚‹

```typescript
// è¨­å®šæ™‚
const repository = repositoryFactory.createAccountRepository();
const service = new AccountService(repository);

// ä½¿ç”¨æ™‚
const service = dataAccessLayer.getServices().account;
```

## ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã®è©³ç´°

```
lib/
â”œâ”€â”€ data-access/           # ğŸ†• çµ±ä¸€ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤
â”‚   â””â”€â”€ index.ts          # DataAccessLayer ã‚¯ãƒ©ã‚¹
â”œâ”€â”€ repositories/         # ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤
â”‚   â”œâ”€â”€ base/             # åŸºåº•ã‚¯ãƒ©ã‚¹
â”‚   â”‚   â””â”€â”€ BaseRepository.ts
â”‚   â”œâ”€â”€ implementations/   # å®Ÿè£…ã‚¯ãƒ©ã‚¹
â”‚   â”‚   â”œâ”€â”€ AccountRepository.ts
â”‚   â”‚   â”œâ”€â”€ PartnerRepository.ts
â”‚   â”‚   â”œâ”€â”€ AnalysisCodeRepository.ts
â”‚   â”‚   â””â”€â”€ JournalRepository.ts
â”‚   â”œâ”€â”€ interfaces/       # ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©
â”‚   â”‚   â”œâ”€â”€ IAccountRepository.ts
â”‚   â”‚   â”œâ”€â”€ IPartnerRepository.ts
â”‚   â”‚   â”œâ”€â”€ IAnalysisCodeRepository.ts
â”‚   â”‚   â”œâ”€â”€ IJournalRepository.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ factory/          # Factory ãƒ‘ã‚¿ãƒ¼ãƒ³
â”‚       â””â”€â”€ RepositoryFactory.ts
â”œâ”€â”€ services/             # ğŸ†• ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤
â”‚   â”œâ”€â”€ implementations/
â”‚   â”‚   â””â”€â”€ AccountService.ts
â”‚   â”œâ”€â”€ interfaces/
â”‚   â”‚   â”œâ”€â”€ IAccountService.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ factory/
â”‚       â””â”€â”€ ServiceFactory.ts
â”œâ”€â”€ schemas/              # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ¼ãƒ
â”‚   â”œâ”€â”€ common/          # å…±é€šã‚¹ã‚­ãƒ¼ãƒ
â”‚   â””â”€â”€ master/          # ãƒã‚¹ã‚¿ç³»ã‚¹ã‚­ãƒ¼ãƒ
â”œâ”€â”€ types/               # å‹å®šç¾©
â””â”€â”€ utils/               # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
```

ğŸ†•: TASK23 ã§æ–°è¦è¿½åŠ ãƒ»å¤§å¹…æ”¹å–„ã•ã‚ŒãŸéƒ¨åˆ†

## æŠ€è¡“çš„ç‰¹å¾´

### 1. å‹å®‰å…¨æ€§

**ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ãƒã‚§ãƒƒã‚¯**

```typescript
// TypeScript ã«ã‚ˆã‚Šå‹ã‚¨ãƒ©ãƒ¼ã‚’äº‹å‰ã«æ¤œå‡º
const account: Account = {
  accountCode: "TEST001",
  accountName: "ãƒ†ã‚¹ãƒˆç§‘ç›®",
  accountType: "invalid_type", // â† ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼
};
```

**å®Ÿè¡Œæ™‚ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**

```typescript
// Zod ã«ã‚ˆã‚Šå®Ÿè¡Œæ™‚ã«ã‚‚ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚’ä¿è¨¼
const result = accountCreateSchema.safeParse(inputData);
if (!result.success) {
  throw new Error(`ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: ${result.error.message}`);
}
```

### 2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªæœ€é©åŒ–**

```typescript
// BaseRepository ã§å…±é€šã®æœ€é©åŒ–ã‚’å®Ÿè£…
class BaseRepository {
  async findPaginated(options: PaginationOptions) {
    // åŠ¹ç‡çš„ãªãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ãŸã‚½ãƒ¼ãƒˆ
    // å¿…è¦ãªåˆ—ã®ã¿ã‚’é¸æŠ
  }
}
```

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥**

```typescript
// ãƒ¡ãƒ¢åŒ–ã«ã‚ˆã‚‹é«˜é€ŸåŒ–
const memoizedConvert = memoize(convertSnakeToCamel);
```

### 3. ä¿å®ˆæ€§

**æ˜ç¢ºãªè²¬å‹™åˆ†é›¢**

- å„å±¤ãŒç‹¬ç«‹ã—ã¦å¤‰æ›´å¯èƒ½
- ä¾å­˜é–¢ä¿‚ã®æ–¹å‘ãŒä¸€æ–¹å‘
- ãƒ†ã‚¹ãƒˆã§ã®æ¤œè¨¼ãŒå®¹æ˜“

### 4. æ‹¡å¼µæ€§

**æ–°æ©Ÿèƒ½ã®è¿½åŠ ä¾‹**

```typescript
// æ–°ã—ã„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®è¿½åŠ 
export interface Invoice extends BaseEntity {
  invoiceNumber: string;
  // ...
}

// å¯¾å¿œã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã®è¿½åŠ 
export class InvoiceRepository extends BaseRepository<
  Invoice,
  InvoiceCreateDto,
  InvoiceUpdateDto
> {
  // BaseRepository ã®æ©æµã‚’å—ã‘ã¦æœ€å°é™ã®å®Ÿè£…ã§æ¸ˆã‚€
}
```

ã“ã® 4 å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ˆã‚Šã€è¤‡é›‘ãªä¼šè¨ˆã‚·ã‚¹ãƒ†ãƒ ã‚’æ•´ç†ã•ã‚ŒãŸå½¢ã§æ§‹ç¯‰ãƒ»ä¿å®ˆã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
