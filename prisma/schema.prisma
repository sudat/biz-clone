// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// マスタテーブル群（完全camelCase統一）
// ============================================================================

// 勘定科目マスタ
model Account {
  accountCode       String   @id @db.VarChar(10)
  accountName       String   @db.VarChar(100)
  accountType       String   @db.VarChar(20)
  parentAccountCode String?  @db.VarChar(10)
  isDetail          Boolean  @default(true)
  isActive          Boolean  @default(true)
  sortOrder         Int?
  createdAt         DateTime @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // 自己参照関係
  parentAccount Account?  @relation("AccountParent", fields: [parentAccountCode], references: [accountCode])
  childAccounts Account[] @relation("AccountParent")

  // 他テーブルとの関係
  subAccounts    SubAccount[]
  journalDetails JournalDetail[]

  @@map("accounts")
}

// 補助科目マスタ
model SubAccount {
  subAccountCode String   @db.VarChar(15)
  accountCode    String   @db.VarChar(10)
  subAccountName String   @db.VarChar(100)
  isActive       Boolean  @default(true)
  sortOrder      Int?
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // 関係
  account        Account         @relation(fields: [accountCode], references: [accountCode])
  journalDetails JournalDetail[]

  // 複合主キー：勘定科目コード + 補助科目コードで一意
  @@id([accountCode, subAccountCode])
  @@map("sub_accounts")
}

// 取引先マスタ
model Partner {
  partnerCode   String   @id @db.VarChar(15)
  partnerName   String   @db.VarChar(100)
  partnerKana   String?  @db.VarChar(100)
  partnerType   String   @db.VarChar(20)
  postalCode    String?  @db.VarChar(8)
  address       String?  @db.VarChar(200)
  phone         String?  @db.VarChar(20)
  email         String?  @db.VarChar(100)
  contactPerson String?  @db.VarChar(50)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // 関係
  journalDetails JournalDetail[]

  @@map("partners")
}

// 分析コードマスタ
model AnalysisCode {
  analysisCode       String   @id @db.VarChar(15)
  analysisName       String   @db.VarChar(100)
  analysisType       String   @db.VarChar(20)
  parentAnalysisCode String?  @db.VarChar(15)
  isActive           Boolean  @default(true)
  sortOrder          Int?
  createdAt          DateTime @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // 自己参照関係
  parentAnalysisCode_rel AnalysisCode?  @relation("AnalysisCodeParent", fields: [parentAnalysisCode], references: [analysisCode])
  childAnalysisCodes     AnalysisCode[] @relation("AnalysisCodeParent")

  // 他テーブルとの関係
  journalDetails JournalDetail[]

  @@map("analysis_codes")
}

// ============================================================================
// 仕訳テーブル群（完全camelCase統一）
// ============================================================================

// 仕訳ヘッダテーブル
model JournalHeader {
  journalNumber String   @id @db.VarChar(15)
  journalDate   DateTime @db.Date
  description   String?  @db.Text
  totalAmount   Decimal  @default(0) @db.Decimal(15, 2)
  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @db.Timestamptz(6)
  createdBy     String?  @db.Uuid

  // 関係
  journalDetails JournalDetail[]

  @@map("journal_headers")
}

// 仕訳明細テーブル
model JournalDetail {
  journalNumber   String   @db.VarChar(15)
  lineNumber      Int
  debitCredit     String   @db.VarChar(1)
  accountCode     String   @db.VarChar(10)
  subAccountCode  String?  @db.VarChar(15)
  partnerCode     String?  @db.VarChar(15)
  analysisCode    String?  @db.VarChar(15)
  amount          Decimal  @db.Decimal(15, 2)
  lineDescription String?  @db.Text
  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // 関係
  journalHeader   JournalHeader @relation(fields: [journalNumber], references: [journalNumber], onDelete: Cascade)
  account         Account       @relation(fields: [accountCode], references: [accountCode])
  subAccount      SubAccount?   @relation(fields: [accountCode, subAccountCode], references: [accountCode, subAccountCode])
  partner         Partner?      @relation(fields: [partnerCode], references: [partnerCode])
  analysisCodeRel AnalysisCode? @relation(fields: [analysisCode], references: [analysisCode])

  // 複合主キー
  @@id([journalNumber, lineNumber])
  @@map("journal_details")
}
